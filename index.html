<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>WebRTC Streaming</title>
    <link rel="stylesheet" href="./styles.css">
</head>

<body>

    <h1>SplitSound v0.0.-1</h1>
    <hr><br>

    <form onsubmit="return false;">
        <div><b>Room name: </b></div>
        <input type="text" id="connectRoom" value="test">
        <div id="streamFrom">
            <div><b>Stream from: </b></div>
            <div class="inputOptions">
                <select id="deviceSelectOptions">
                    <option value="none" data-owner="html">None</option>
                    <option value="file" data-owner="html">File</option>
                    <!-- Auto-generated options -->
                </select>
            </div>
        </div>

        <div>
            <button id="connectButton">Connect</button>
        </div>
    </form>

    <h2>Local:</h2>
    <h3>ID: <span id="socketId">disconnected</span></h3>
    <div id="localMedia">
        <video id="localVideo" class="localVideo" autoplay controls muted></video>
        <audio id="localAudio" class="hidden" autoplay controls></audio>
    </div>
    <select id="vizualizerOptions">
        <option value="line">Line</option>
        <option value="bar">Bar</option>
        <option value="none">Disabled</option>
    </select><br><br>
    <canvas id="visualizer" width="512" height="300"></canvas>

    <h2>Remote Connections:</h2>
    <div id="remoteMedia"></div>

    <script type="text/javascript" src="./node_modules/socket.io-client/dist/socket.io.js"></script>
    <script type="text/javascript" src="./node_modules/webrtc-adapter/out/adapter.js"></script>
    <script type="text/javascript" src="./lib.js"></script>
    <script type="text/javascript">
        let deviceSelect = document.getElementById('deviceSelectOptions');
        let socket = new Socket('https://signals.symboxtra.dynu.net', 443);
        createAudioContext(44100.0);

        // Fill the device selector
        updateDeviceList(deviceSelect);

        // Start connection
        document.getElementById('connectButton').addEventListener('click', async () => {
            resetConnection(socket);

            let sel = deviceSelect[deviceSelect.selectedIndex];
            let owner = sel.getAttribute('data-owner') || '';

            switch (owner) {
                case 'hulaloop':
                    await setupLocalMediaStreamFromHulaLoop(sel.value);
                    break;
                case 'browser':
                    await setupLocalMediaStreams(sel.value);
                    break;
                case 'html':
                    switch (sel.value) {
                        case 'file':
                            await setupLocalMediaStreamsFromFile('./test_file_left_panned_sweep.mp3');
                            break;
                        case 'none':
                        default:
                            enableReceiverOnly();
                            break;
                    }
                    break;
                default:
                    console.warn(`Unrecognized owner: ${sel.getAttribute('data-owner')}`);
                    break;
            }

            let room = document.getElementById('connectRoom').value;
            socket.joinRoom(room);
        });

        document.addEventListener('keyup', (e) => {
            if (e.which === 123) {
                if (settings.isElectron) {
                    require('remote').getCurrentWindow().toggleDevTools();
                }
            } else if (e.which === 116) {
                location.reload();
            }
        });

    </script>
</body>

</html>
